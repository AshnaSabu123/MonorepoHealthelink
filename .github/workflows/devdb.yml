name: Synthetic Devl UDI schema generator

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Polyglot Prime Tag Version'
        required: true

jobs:
  test-step:
    runs-on: ubuntu-latest
    env:
      SQL_AIDE_TAG: v0.14.9

    steps:
      - name: Running schema generation
        run: echo "Running schema generation"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Deno
        run: |
          curl -fsSL https://deno.land/x/install/install.sh | sh
          echo "$HOME/.deno/bin" >> $GITHUB_PATH

      - name: Clone Polyglot Prime repository
        run: |
          git clone https://github.com/anoopvarma-2000-p/polyglot-prime.git

      # --------------------------------------------------
      # Fix npm:json5 & node_modules for sql-aide
      # --------------------------------------------------
      - name: Configure Deno npm dependencies
        run: |
          cd polyglot-prime/udi-prime

          # Enable node_modules auto creation
          if [ -f deno.json ]; then
            node -e '
              const fs=require("fs");
              const p="deno.json";
              const j=JSON.parse(fs.readFileSync(p,"utf8"));
              j.nodeModulesDir="auto";
              fs.writeFileSync(p, JSON.stringify(j,null,2));
            '
          else
            cat > deno.json <<'EOF'
          {
            "nodeModulesDir": "auto"
          }
          EOF
          fi

          # Ensure npm:json5 is available
          if [ -f package.json ]; then
            node -e '
              const fs=require("fs");
              const p="package.json";
              const j=JSON.parse(fs.readFileSync(p,"utf8"));
              j.private=true;
              j.dependencies=j.dependencies||{};
              j.dependencies.json5=j.dependencies.json5||"^2.2.3";
              fs.writeFileSync(p, JSON.stringify(j,null,2));
            '
          else
            cat > package.json <<'EOF'
          {
            "name": "udi-prime-ci",
            "private": true,
            "dependencies": {
              "json5": "^2.2.3"
            }
          }
          EOF
          fi

          deno install

      # --------------------------------------------------
      # UDI pipeline
      # --------------------------------------------------
      - name: Generate SQL
        run: |
          cd polyglot-prime/udi-prime
          ./udictl.ts ic generate sql

      - name: Load SQL
        run: |
          cd polyglot-prime/udi-prime
          ./udictl.ts ic load-sql --conn-id DEVL_TECHBD_UDI_DS

      - name: Show Load SQL log
        run: |
          cd polyglot-prime/udi-prime
          cat $(ls -t ./udictl-load-sql-*.log | head -n 1)

      - name: Run UDI tests
        run: |
          cd polyglot-prime/udi-prime
          ./udictl.ts ic test --conn-id DEVL_TECHBD_UDI_DS

      - name: Run UDI migrations
        run: |
          cd polyglot-prime/udi-prime
          ./udictl.ts ic migrate --conn-id DEVL_TECHBD_UDI_DS --is-linted false

      - name: Show UDI test log
        run: |
          cd polyglot-prime/udi-prime
          cat $(ls -t ./udictl-test-*.log | head -n 1)

      # --------------------------------------------------
      # Database migration with proper env + Deno perms
      # --------------------------------------------------
      - name: Run DB infrastructure migration
        run: |
          cd polyglot-prime/udi-prime/src/main/postgres/ingestion-center/migrations
          echo "SPRING_PROFILES_ACTIVE=$SPRING_PROFILES_ACTIVE"
          deno run \
            --allow-read \
            --allow-env=SPRING_PROFILES_ACTIVE,devl_TECHBD_UDI_DS_READER_JDBC_USERNAME \
            migrate-basic-infrastructure.ts
        env:
          SPRING_PROFILES_ACTIVE: devl
          devl_TECHBD_UDI_DS_READER_JDBC_USERNAME: ${{ secrets.DEVL_TECHBD_UDI_DS_READER_JDBC_USERNAME }}
